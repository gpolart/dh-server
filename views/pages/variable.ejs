<!DOCTYPE html>
<html lang="en">
<head>
    <% include ../partials/head %>
</head>
<body class="container-fluid">

    <header>
        <% include ../partials/header %>
    </header>


    <main>
        <div class="row">
            <div class="col-md-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h2 class="panel-title">Edit variable meta-data</h2>
                    </div>
                    <div class="panel-content">
                        <form id="var-form">
                            <div class="form-group">
                                <label class="col-sm-4 control-label" for="ident">Ident</label>
                                <div class="col-sm-8">
                                    <p class="form-control-static"><%= variable.ident %></p>
                                    <input type="hidden" id="ident" value="<%= variable.ident %>">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label" for="last_seen">Last seen</label>
                                <div class="col-sm-8">
                                    <p class="form-control-static"><%= variable.meta.last_seen %></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label" for="last_value">Last value</label>
                                <div class="col-sm-8">
                                    <p class="form-control-static"><%= variable.meta.last_value %></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label" for="name">Name</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="name" placeholder="Name" value="<%= variable.meta.name %>">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label" for="name">Type</label>
                                <div class="col-sm-8">
                                    <select id="var-type" class="form-control">
                                        <% types.forEach(function(item) { %>
                                            <option <% if (item === variable.meta.type) { %>selected="yes"<% } %> ><%= item %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label" for="name">Groups</label>
                                <div class="col-sm-8">
                                        <p><% groups.join(', ', variable.meta.groups) %> <span><button>Add</button></span></p>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-default">OK</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div id="values">
                </div>
            </div>
        </div>
    </main>
    <footer>
        <% include ../partials/footer %>
    </footer>
    
    <% include ../partials/javascript %>
    <script type="text/javascript">
    $(document).ready(function() {

         $('#var-form').on('submit', function(ev) {
            ev.preventDefault();
            var ident = $('#ident').val();
            var name = $('#name').val();
            var type = $('#var-type').val();

            $.ajax({
               url: '/variable',
               type: 'POST',
               dataType: 'json',
               data: { ident : ident,
                       name : name,
                       type : type
                     }
            }).done(function( result ) {
               if ($.isPlainObject(result)) {
                    if (result.status === "OK") {
                    }
                    else {
                        alert('Erreur système');
                    }
                }
                else {
                    alert('Erreur système');
                }
            }).fail(function(err) {
                alert('Erreur  err = ' + err);
            });
         });

         function draw_values_as_table(values) {
            $('#values').empty();
            var $table = $('<table class="table"></table>').appendTo($('#values'));
            $('<thead><tr><th>Date</th><th>Values</th></tr></thead>').appendTo($table);
            var $tbody = $('<tbody></tbody>').appendTo($table);
            var lines = values.split("\n");
            $.each(lines, function(num, l) {
                var items = l.split(":");
                var date = new Date(1*items[0]);
                console.log ("item[0]  "+items[0]+"  date " + date);
                var sd = date.formatISO(true, false);
                $('<tr><td>'+sd+'</td><td>'+items[1]+'</td></tr>').appendTo($table);
            });
         }

         function draw_values_as_chart(values) {
            draw_values_as_table(result.values);
         };

         function load_values(id, type) {
            console.log("id = " + id);
            $.ajax({
               url: '/api/get_values',
               type: 'GET',
               data: {ident : id}
            }).done(function( result ) {
               if ($.isPlainObject(result)) {
                    if (result.status === "OK") {
                        if (type === 'Numeric') {
                            draw_values_as_chart(result.values);
                        }
                        else {
                            draw_values_as_table(result.values);
                        }
                    }
                    else {
                        alert('Erreur système');
                    }
                }
                else {
                    alert('Erreur système');
                }
            }).fail(function(err) {
                alert('Erreur  err = ' + err);
            });
         }

        load_values('<%= variable.ident %>', '<%= variable.type %>');
    });
    </script> 
</body>
</html>
